"use strict";(self.webpackChunk_dhis2_app_shell=self.webpackChunk_dhis2_app_shell||[]).push([[1709],{11671:function(e,t,a){a.d(t,{V:function(){return y}});var r=a(58921),n=a(76465),i=a(83590),s=a(54161),c=a(8872),o=a.n(c),l=a(51654),d=a.n(l),u=a(21758);const m=e=>{let{amount:t,invert:a,className:s}=e;return u.createElement("div",{className:r.default.dynamic([["686723300",[t]],["3392977398",[n.w.primary600,i.T.white]]])+" "+(o()(s,{invert:a})||"")},u.createElement(r.default,{id:"686723300",dynamic:[t]},["div.__jsx-style-dynamic-selector{width:".concat(t,"%;}")]),u.createElement(r.default,{id:"3392977398",dynamic:[n.w.primary600,i.T.white]},["div.__jsx-style-dynamic-selector{background-color:".concat(n.w.primary600,";-webkit-transition:width 0.3s linear;transition:width 0.3s linear;height:4px;}"),".invert.__jsx-style-dynamic-selector{background-color:".concat(i.T.white,";}")]))};m.propTypes={amount:d().number.isRequired,className:d().string,invert:d().bool};const y=e=>{let{amount:t,width:a,margin:n,invert:i,className:s,dataTest:c}=e;return u.createElement("div",{role:"progressbar","data-test":c,className:"jsx-3127531794 "+r.default.dynamic([["3224415970",[a,n]]])+" "+(o()(s,{invert:i})||"")},u.createElement(m,{amount:t,invert:i}),u.createElement(r.default,{id:"3127531794"},["div.jsx-3127531794{display:block;overflow:hidden;overflow-x:hidden;overflow-y:hidden;background-color:rgba(110,122,138,0.15);}",".invert.jsx-3127531794{background-color:rgba(33,41,52,0.5);}"]),u.createElement(r.default,{id:"3224415970",dynamic:[a,n]},["div.__jsx-style-dynamic-selector{width:".concat(a,";margin:").concat(n,";}")]))};y.defaultProps={margin:s.Q.dp12,width:"300px",dataTest:"dhis2-uicore-linearloader"},y.propTypes={amount:d().number.isRequired,className:d().string,dataTest:d().string,invert:d().bool,margin:d().string,width:d().string}},11709:function(e,t,a){a.r(t),a.d(t,{default:function(){return w}});var r=a(4147),n=a(66190),i=a(41887),s=a(11671),c=a(21758),o=a(50433),l=a(16272),d=a(26802),u=a(39398),m=a(59541),y=a(65298);const v=(e=[])=>(0,m.fromPairs)(null===e||void 0===e?void 0:e.map(e=>[e,{resource:d.DATASTORE_OLD_SCORECARD_ENDPOINT,id:e}]));const g=async({newScorecard:e,engine:t})=>{if(e)return await t.mutate((0,d.generateCreateMutation)(null===e||void 0===e?void 0:e.id),{variables:{data:e}})};const p={type:"update",resource:d.DATASTORE_ENDPOINT,id:d.DATASTORE_SCORECARD_SUMMARY_KEY,data:({data:e})=>e},f=async(e,t)=>await e.mutate(p,{variables:{data:t}});function h(e){const[t,a]=(0,c.useState)(),n=(0,y.useRecoilValue)(d.AllScorecardsSummaryState),i=(0,y.useRecoilRefresher_UNSTABLE)(d.AllScorecardsSummaryState),[s,o]=(0,c.useState)(),p=(0,r.ow)(),[,{set:h}]=(0,l.iK)(d.DATA_MIGRATION_CHECK,{global:!0}),w=(0,c.useCallback)(async e=>{await g({newScorecard:e,engine:p})},[p]),E=(0,c.useCallback)(async()=>{await f(p,(0,m.uniqBy)([...n,...s],"id")),i(),h(!0),e()},[n,p,e,i,h,s]),{add:_,progress:S,length:A,started:T}=function({drain:e,task:t}){var a,r,n,i;const[s,o]=(0,c.useState)(0),l=(0,c.useRef)(u.Ay.queue((e,a)=>{t(e).then(e=>{a(e)})},1));null===(a=l.current)||void 0===a||a.drain(e);const d=(0,c.useCallback)(e=>{l.current.push(e,e=>{e&&console.error(e),o(e=>e+1)})},[]);return{add:d,started:null===(r=l.current)||void 0===r?void 0:r.started,kill:null===(n=l.current)||void 0===n?void 0:n.kill,progress:s,length:null===(i=l.current)||void 0===i?void 0:i.length()}}({drain:E,task:w}),b=(0,c.useCallback)(async()=>{try{const t=await async function(e){try{var t;const{keys:a}=null!==(t=await e.query({keys:{resource:d.DATASTORE_ENDPOINT}}))&&void 0!==t?t:{};return(0,m.filter)(a,e=>!(e.includes(d.DATASTORE_SCORECARD_SUMMARY_KEY)||e.includes("settings")||e.includes("savedObjects")))}catch(a){return[]}}(p),a=await async function(e){try{var t;const{keys:a}=null!==(t=await e.query({keys:{resource:d.DATASTORE_OLD_SCORECARD_ENDPOINT}}))&&void 0!==t?t:{};return a}catch(a){return[]}}(p),r=(0,m.filter)(a,e=>!t.includes(e));if(r&&!(0,m.isEmpty)(r)){const e=(0,m.compact)(await async function(e,t){if((0,m.isEmpty)(t))return[];const a=await e.query(v(t)),r=[];return(0,m.forIn)(a,(e,t)=>{r.push({...e,id:t})}),r}(p,r)),t=(0,m.compact)(await(0,u.Tj)(e,async e=>await(0,d.migrateScorecard)(e,p))),a=(0,m.compact)((0,m.map)(t,d.generateScorecardSummary));o(a);for(const r of t)_(r)}else e(),h(!0)}catch(t){a(t),h(!0),e()}},[_,p,e,h]);return(0,c.useEffect)(()=>{b()},[]),{progress:S,count:S+A,error:t,migrationStarted:T}}function w(){const e=(0,o.W6)(),{show:t}=(0,r.MW)(({message:e})=>e,({type:e})=>({...e,duration:3e3})),{error:a,progress:l,count:d,migrationStarted:u}=h(()=>{e.replace("/")});return(0,c.useEffect)(()=>{var e;a&&t({message:n.A.t("Error Migrating Scorecards: "+(null!==(e=null===a||void 0===a?void 0:a.message)&&void 0!==e?e:"")),type:{info:!0}})},[a,t]),u?c.createElement("div",{className:"column center align-items-center h-100 w-100"},c.createElement(s.V,{amount:l/d*100}),c.createElement("h4",null,n.A.t("Migrating scorecards"),"...",+l," ",n.A.t("of")," ",+d)):c.createElement("div",{className:"column center align-items-center h-100 w-100"},c.createElement(i.F,{small:!0}),c.createElement("h4",null,n.A.t("Preparing migration...")))}}}]);
//# sourceMappingURL=1709.3aec17e9.chunk.js.map