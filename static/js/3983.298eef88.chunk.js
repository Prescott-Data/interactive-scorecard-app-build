"use strict";(self.webpackChunk_dhis2_app_shell=self.webpackChunk_dhis2_app_shell||[]).push([[3983],{33983:function(e,t,r){r.r(t),r.d(t,{default:function(){return E}});var a=r(7105),n=r(26874),i=r(84415),s=r(65228),c=r(81195),o=r(29989),l=r(40652),u=r(6585),d=r(71387),m=r(69987),y=r(25435);const v=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return(0,m.fromPairs)(null===e||void 0===e?void 0:e.map((e=>[e,{resource:u.DATASTORE_OLD_SCORECARD_ENDPOINT,id:e}])))};const g=async e=>{let{newScorecard:t,engine:r}=e;if(t)return await r.mutate((0,u.generateCreateMutation)(null===t||void 0===t?void 0:t.id),{variables:{data:t}})};const f={type:"update",resource:u.DATASTORE_ENDPOINT,id:u.DATASTORE_SCORECARD_SUMMARY_KEY,data:e=>{let{data:t}=e;return t}},p=async(e,t)=>await e.mutate(f,{variables:{data:t}});function h(e){const[t,r]=(0,c.useState)(),n=(0,y.useRecoilValue)(u.AllScorecardsSummaryState),i=(0,y.useRecoilRefresher_UNSTABLE)(u.AllScorecardsSummaryState),[s,o]=(0,c.useState)(),f=(0,a.bQ)(),[,{set:h}]=(0,l.yu)(u.DATA_MIGRATION_CHECK,{global:!0}),E=(0,c.useCallback)((async e=>{await g({newScorecard:e,engine:f})}),[f]),w=(0,c.useCallback)((async()=>{await p(f,(0,m.uniqBy)([...n,...s],"id")),i(),h(!0),e()}),[n,f,e,i,h,s]),{add:_,progress:S,length:b,started:A}=function(e){var t,r,a,n;let{drain:i,task:s}=e;const[o,l]=(0,c.useState)(0),u=(0,c.useRef)(d.ZP.queue(((e,t)=>{s(e).then((e=>{t(e)}))}),1));null===(t=u.current)||void 0===t||t.drain(i);const m=(0,c.useCallback)((e=>{u.current.push(e,(e=>{e&&console.error(e),l((e=>e+1))}))}),[]);return{add:m,started:null===(r=u.current)||void 0===r?void 0:r.started,kill:null===(a=u.current)||void 0===a?void 0:a.kill,progress:o,length:null===(n=u.current)||void 0===n?void 0:n.length()}}({drain:w,task:E}),T=(0,c.useCallback)((async()=>{try{const t=await async function(e){try{var t;const{keys:r}=null!==(t=await e.query({keys:{resource:u.DATASTORE_ENDPOINT}}))&&void 0!==t?t:{};return(0,m.filter)(r,(e=>!(e.includes(u.DATASTORE_SCORECARD_SUMMARY_KEY)||e.includes("settings")||e.includes("savedObjects"))))}catch(r){return[]}}(f),r=await async function(e){try{var t;const{keys:r}=null!==(t=await e.query({keys:{resource:u.DATASTORE_OLD_SCORECARD_ENDPOINT}}))&&void 0!==t?t:{};return r}catch(r){return[]}}(f),a=(0,m.filter)(r,(e=>!t.includes(e)));if(a&&!(0,m.isEmpty)(a)){const e=(0,m.compact)(await async function(e,t){if((0,m.isEmpty)(t))return[];const r=await e.query(v(t)),a=[];return(0,m.forIn)(r,((e,t)=>{a.push({...e,id:t})})),a}(f,a)),t=(0,m.compact)(await(0,d.UI)(e,(async e=>await(0,u.migrateScorecard)(e,f)))),r=(0,m.compact)((0,m.map)(t,u.generateScorecardSummary));o(r);for(const a of t)_(a)}else e(),h(!0)}catch(t){r(t),h(!0),e()}}),[_,f,e,h]);return(0,c.useEffect)((()=>{T()}),[]),{progress:S,count:S+b,error:t,migrationStarted:A}}function E(){const e=(0,o.k6)(),{show:t}=(0,a.VY)((e=>{let{message:t}=e;return t}),(e=>{let{type:t}=e;return{...t,duration:3e3}})),{error:r,progress:l,count:u,migrationStarted:d}=h((()=>{e.replace("/")}));return(0,c.useEffect)((()=>{var e;r&&t({message:n.Z.t("Error Migrating Scorecards: "+(null!==(e=null===r||void 0===r?void 0:r.message)&&void 0!==e?e:"")),type:{info:!0}})}),[r,t]),d?c.createElement("div",{className:"column center align-items-center h-100 w-100"},c.createElement(s.j,{amount:l/u*100}),c.createElement("h4",null,n.Z.t("Migrating scorecards"),"...",+l," ",n.Z.t("of")," ",+u)):c.createElement("div",{className:"column center align-items-center h-100 w-100"},c.createElement(i.V,{small:!0}),c.createElement("h4",null,n.Z.t("Preparing migration...")))}},65228:function(e,t,r){r.d(t,{j:function(){return y}});var a=r(41402),n=r(85703),i=r(13488),s=r(62651),c=r(20094),o=r.n(c),l=r(477),u=r.n(l),d=r(81195);const m=e=>{let{amount:t,invert:r,className:s}=e;return d.createElement("div",{className:a.default.dynamic([["686723300",[t]],["3392977398",[n.r.primary600,i.O.white]]])+" "+(o()(s,{invert:r})||"")},d.createElement(a.default,{id:"686723300",dynamic:[t]},["div.__jsx-style-dynamic-selector{width:".concat(t,"%;}")]),d.createElement(a.default,{id:"3392977398",dynamic:[n.r.primary600,i.O.white]},["div.__jsx-style-dynamic-selector{background-color:".concat(n.r.primary600,";-webkit-transition:width 0.3s linear;transition:width 0.3s linear;height:4px;}"),".invert.__jsx-style-dynamic-selector{background-color:".concat(i.O.white,";}")]))};m.propTypes={amount:u().number.isRequired,className:u().string,invert:u().bool};const y=e=>{let{amount:t,width:r,margin:n,invert:i,className:s,dataTest:c}=e;return d.createElement("div",{role:"progressbar","data-test":c,className:"jsx-3127531794 "+a.default.dynamic([["3224415970",[r,n]]])+" "+(o()(s,{invert:i})||"")},d.createElement(m,{amount:t,invert:i}),d.createElement(a.default,{id:"3127531794"},["div.jsx-3127531794{display:block;overflow:hidden;overflow-x:hidden;overflow-y:hidden;background-color:rgba(110,122,138,0.15);}",".invert.jsx-3127531794{background-color:rgba(33,41,52,0.5);}"]),d.createElement(a.default,{id:"3224415970",dynamic:[r,n]},["div.__jsx-style-dynamic-selector{width:".concat(r,";margin:").concat(n,";}")]))};y.defaultProps={margin:s.i.dp12,width:"300px",dataTest:"dhis2-uicore-linearloader"},y.propTypes={amount:u().number.isRequired,className:u().string,dataTest:u().string,invert:u().bool,margin:u().string,width:u().string}}}]);
//# sourceMappingURL=3983.298eef88.chunk.js.map